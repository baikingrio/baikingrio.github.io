<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="稻草人的个人站点"><title>使用BmobJava云函数统计数据 | 稻草人</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用BmobJava云函数统计数据</h1><a id="logo" href="/.">稻草人</a><p class="description">大成若缺，其用不弊；大盈若冲，其用不穷。大直若屈，大巧若拙，大辩若诺。躁胜寒，静胜热，清静为天下正。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用BmobJava云函数统计数据</h1><div class="post-meta">Dec 27, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="2017/12/27/使用BmobJava云函数统计数据/" href="/2017/12/27/使用BmobJava云函数统计数据/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="云函数简介"><a href="#云函数简介" class="headerlink" title="云函数简介"></a>云函数简介</h3><p>云函数是一段部署在服务端的代码片段，通过云函数可以解决很多复杂的业务逻辑，无需将大量的数据发送到客户端做计算处理，大大减轻了客户端业务开发的复杂度。<br>另外，更新云函数代码片段，客户端无需更新，便满足业务改动的需求，这样云函数便有更多的灵活性和自主性。</p>
<h3 id="编程语言"><a href="#编程语言" class="headerlink" title="编程语言"></a>编程语言</h3><p>目前Bmob云函数支持Node.js和Java两种编程语言。</p>
<h3 id="云函数执行方式"><a href="#云函数执行方式" class="headerlink" title="云函数执行方式"></a>云函数执行方式</h3><p>创建好的云函数支持三种执行方式：</p>
<ul>
<li>定时任务<br>在服务端创建并设置定时任务规则后定时执行指定的云函数</li>
<li>RESTful Api调用<br>通过Restful api接口调用指定云函数返回执行结果</li>
<li>SDK调用<br>通过Bmob数据服务提供的相关平台SDK中提供的方法调用指定云函数</li>
</ul>
<h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><p>假设现在有一张用户表<code>_User</code>存储注册的用户信息，主要的基本字段如下：<br>| 字段          | 数据类型      |  描述  |<br>| ——–      | :—–:       | —-:  |<br>| username      | String        |  用户名     |<br>| password      | String        |  密码   |<br>| type          | Integer       |  用户类型(1普通用户、2高级用户)  |</p>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>老板要求统计每天不同类型的用户注册量</p>
<h3 id="创建云函数"><a href="#创建云函数" class="headerlink" title="创建云函数"></a>创建云函数</h3><p>在Bmob控制台创建countRegister的云函数<br><img src="/2017/12/27/使用BmobJava云函数统计数据/create.png" title="This is an create image"></p>
<p>创建后台的countRegister云函数的默认内容如下：<br><img src="/2017/12/27/使用BmobJava云函数统计数据/function.png" title="This is an function image"></p>
<p>在onRequest方法体中我们将实现注册量统计的逻辑，这里需要注意几点：</p>
<blockquote>
<ul>
<li>方法名、入参及返回类型不允许任何修改</li>
<li>代码中不能包含以下关键字<br>Class<br>File<br>System<br>…</li>
<li>需要获取当前毫秒时，可用 getTime() 、new java.util.Date().getTime() 替代 System.currentTimeMillis()</li>
<li>如果确实需要用到被禁止使用的关键字，例如查询”File”表，可用”F”+”ile”的形式拼接</li>
<li>不可包含/**/注释，如需注释，请用 //</li>
<li>仅可写一个Java的方法，不能写多个方法、类变量、静态变量等</li>
<li>云函数执行完毕后，必须用response.send方法返回响应数据，否则会被当做超时，多次超时可能会被暂停使用</li>
</ul>
</blockquote>
<p>了解了以上规则后我们就来开始编写统计数据的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 按type字段进行分组统计</span><br><span class="line">Querier qt = new Querier(&quot;_User&quot;)</span><br><span class="line">                .limit(1000)</span><br><span class="line">                .groupby(&quot;type&quot;)</span><br><span class="line">                .groupcount(true);</span><br><span class="line">// 条件 = 创建时间在12小时内</span><br><span class="line">qt.addWhereGreaterThanOrEqualTo(&quot;createdAt&quot;, new BmobDate(getTime() - 12 * 60 * 60 * 1000));</span><br><span class="line">// 使用oData对象的find方法进行数据的查询统计</span><br><span class="line">HttpResponse httpResponse = modules.oData.find(qt);</span><br><span class="line">// 将查询统计得到的数据通过httpResponse返回给调用云函数的请求方</span><br><span class="line">response.send(httpResponse.jsonData);</span><br></pre></td></tr></table></figure></p>
<h3 id="调用云函数"><a href="#调用云函数" class="headerlink" title="调用云函数"></a>调用云函数</h3><p>云函数的调用支持以下几种方式：<br>|调用方式    |所需信息    |优点<br>| ——–      | :—–        | :—-  |<br>|SDK            |AppId            |交互自带加密,接入快速<br>|RestApi        |AppId、RestKey    |所有平台适用，通用性强<br>|Http请求        |Secret Key        |所有平台适用，可用浏览器打开</p>
<p>这里使用Http请求的方式调用<code>countRegister</code>云函数进行测试，在浏览器中请求如下地址：<code>https://javacloud.bmob.cn/****/countRegister</code>,星号请替换为您Bmob应用的<code>SectetKey</code>，<br>这个时候假设当前<code>_User</code>表中存储的数据如下：<br>| username      | password      |  type  |<br>| ——–      | :—–        | :—-  |<br>| zhangsan      | 123456        |  1     |<br>| lisi          | 123456        |  2     |<br>| wangwo        | 123456        |  1     |<br>执行此云函数返回的Json数据将是如下结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;results&quot;:[&#123;&quot;_count&quot;:1,&quot;type&quot;:2&#125;,&#123;&quot;_count&quot;:2,&quot;type&quot;:1&#125;]&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>results</code>中的结果分别是普通用户(type=1)和高级用户(type=2)的注册总数。<br>到此已经实现了基本的统计操作，主要是在云函数中使用了数据服务的查询功能来进行统计查询。而实际的业务中可能需要我们将统计的结果存储到相关的数据表中方便以后做报表展示，所以我们接下来继续完善一下这个<code>countRegister</code>云函数，将统计的结果存储到一张表中。</p>
<h3 id="保存统计数据"><a href="#保存统计数据" class="headerlink" title="保存统计数据"></a>保存统计数据</h3><p>新建一个<code>Statistics</code>表,存储统计后的结果，结构如下：<br>| 字段          | 数据类型      |  描述  |<br>| ——–      | :—–:       | —-:  |<br>| generalUserCount          | Integer       |  普通用户注册数量     |<br>| advancedUserCount         | Integer       |  高级用户注册数量   |</p>
<p>加入存储统计数据的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// 按type字段进行分组统计</span><br><span class="line">Querier qt = new Querier(&quot;_User&quot;)</span><br><span class="line">                .limit(1000)</span><br><span class="line">                .groupby(&quot;type&quot;)</span><br><span class="line">                .groupcount(true);</span><br><span class="line">// 条件 = 创建时间在12小时内</span><br><span class="line">qt.addWhereGreaterThanOrEqualTo(&quot;createdAt&quot;, new BmobDate(getTime() - 12 * 60 * 60 * 1000));</span><br><span class="line">// 使用oData对象的find方法进行数据的查询统计</span><br><span class="line">HttpResponse httpResponse = modules.oData.find(qt);</span><br><span class="line">// 将查询统计得到的数据通过httpResponse返回给调用云函数的请求方</span><br><span class="line">//response.send(httpResponse.jsonData);</span><br><span class="line">        </span><br><span class="line">JSONArray results = httpResponse.jsonData.getJSONArray(&quot;results&quot;);</span><br><span class="line">if (results == null) &#123;</span><br><span class="line">    response.send(httpResponse.data);   // 请求有错误，直接返回全部内容</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    JSONObject statisticsData = new JSONObject();</span><br><span class="line">    for(int i = 0; i &lt; results.size(); i++)&#123;</span><br><span class="line">        JSONObject obj = results.getJSONObject(i);</span><br><span class="line">        int type = obj.getInteger(&quot;type&quot;);</span><br><span class="line">        int count = obj.getInteger(&quot;_count&quot;);</span><br><span class="line">        if(type == 1)&#123;</span><br><span class="line">            // 普通用户总数</span><br><span class="line">            statisticsData.put(&quot;generalUserCount&quot;, count);</span><br><span class="line">        &#125;else if(type == 2)&#123;</span><br><span class="line">            // 高级用户总数</span><br><span class="line">            statisticsData.put(&quot;advancedUserCount&quot;, count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 保存数据并返回执行结果</span><br><span class="line">    response.send(modules.oData.insert(&quot;Statistics&quot;, statisticsData).stringData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>保存好代码后再次调用该云函数，返回结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;createdAt&quot;: &quot;2017-12-27 16:04:35&quot;,&quot;objectId&quot;: &quot;8401a6d2d9&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>表示插入<code>Statistics</code>表数据成功后返回的数据objectId和创建时间，Bmob控制台数据浏览<code>Statistics</code>表，已经存在统计后的数据了：<br><img src="/2017/12/27/使用BmobJava云函数统计数据/statistics.png" title="This is an statistics image"></p>
<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p>上面的云函数已经基本完成了用户注册数的统计以及保存统计数据的工作，但是当我们需要统计的时候还需要手动的调用<code>countRegister</code>云函数才行。实际上我们可以创建一个定时任务在固定时间来执行这个统计操作。在云函数的编写页面选择定时任务，设置执行规则后保存即可，具体设置如下：<br><img src="/2017/12/27/使用BmobJava云函数统计数据/timing_tasks.png" title="This is an timing_tasks image"><br>上面的规则是每天的23点执行该云函数，定时任务的执行规则可以参考<a href="http://doc.bmob.cn/cloud_function/web/timing_tasks/" target="_blank" rel="noopener">定时任务</a>文档说明。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文以一个统计用户注册数量的简单实例来讲解了Bmob云函数的使用，主要在云函数中使用到了数据服务的查询数据和插入数据来实现，并在最后介绍了定时任务+云函数的搭配使用。很多时候，单纯的前端代码是不能完成全部事情的，一些重要和复杂的业务逻辑还是希望能够在服务端中执行。比如：对比较大量的比赛数据进行排序、对某些数据进行分析和处理、获取用户的IP信息等等。</p>
<hr>
<ul>
<li>本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC-BY-NC-SA 4.0 许可协议</a>进行许可</li>
<li>欢迎转载，但请注明来自<a href="http://www.googol.tech/">稻草人</a>，并保持转载后文章内容的完整，本人保留所有版权相关权利。</li>
</ul>
<p>本文链接：<a href="http://www.googol.tech/2017/12/27/使用BmobJava云函数统计数据/">http://www.googol.tech/2017/12/27/使用BmobJava云函数统计数据/</a></p>
</div><iframe src="/donate/?AliPayQR=/img/AliPayQR.png&amp;WeChatQR=/img/WeChatQR.png&amp;GitHub=https://github.com/Kaiyuan/donate-page&amp;BTCQR=/img/BTCQR.png&amp;BTCKEY=1HHjzAoKYdbebDcbYTDG3o77FNHJPo5EpE&amp;PayPal=null" style="overflow-x:hidden;overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/Bmob/">Bmob</a></div><div class="post-nav"><a href="/2018/03/01/手摸手一步一步来制作BmobJavaSDK-一/" class="pre">手摸手一步一步来制作BmobJavaSDK(一)</a><a href="/2017/11/17/SpringBoot消费BmobAPI/" class="next">SpringBoot消费BmobAPI</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'baikingrio';
var disqus_identifier = '2017/12/27/使用BmobJava云函数统计数据/';
var disqus_title = '使用BmobJava云函数统计数据';
var disqus_url = 'http://www.googol.tech/2017/12/27/使用BmobJava云函数统计数据/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//baikingrio.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.googol.tech"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">Kubernetes</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/CentOS/" style="font-size: 25px;">CentOS</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Bmob/" style="font-size: 20px;">Bmob</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/01/手摸手一步一步来制作BmobJavaSDK-一/">手摸手一步一步来制作BmobJavaSDK(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/27/使用BmobJava云函数统计数据/">使用BmobJava云函数统计数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/17/SpringBoot消费BmobAPI/">SpringBoot消费BmobAPI</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/CentOS-7系统安装/">CentOS 7系统安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/CentOS-7安装Jenkins/">CentOS 7安装Jenkins</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/CentOS-7安装Docker/">CentOS 7安装Docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/CentOS-7安装JDK/">CentOS 7安装JDK</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/Docker搭建本地镜像仓库/">Docker搭建本地镜像仓库</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/Kubernetes-Node-安装与配置-Ubuntu系统/">Kubernetes Node 安装与配置(Ubuntu系统)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/22/GitHub Pages+Hexo搭建博客/">GitHub Pages+Hexo搭建博客</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//baikingrio.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="http://www.bmob.cn/" title="Bmob" target="_blank">Bmob</a><ul></ul><a href="http://www.yfshare.vip/" title="Jack Wang Blog" target="_blank">Jack Wang Blog</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">稻草人.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><script async="async" src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></br><a id="busuanzi_container_site_pv">本站总访问量<span id='busuanzi_value_site_pv'></span>次</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>